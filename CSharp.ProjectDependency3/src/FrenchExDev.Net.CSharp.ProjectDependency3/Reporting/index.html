<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Code Graph</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #app {
            height: 100%;
            display: grid;
            grid-template-rows: auto1fr;
        }

        header {
            padding: 8px12px;
            background: #222;
            color: #fff;
            font-family: system-ui, sans-serif;
        }

        main {
            display: grid;
            grid-template-columns: 300px1fr;
            height: 100%;
        }

        aside {
            border-right: 1px solid #ddd;
            padding: 8px;
            overflow: auto;
            font-family: system-ui, sans-serif;
        }

        #canvas {
            position: relative;
        }

        .node circle {
            stroke: #333;
            stroke-width: 1px;
        }

        .node text {
            font: 12px system-ui;
            pointer-events: none;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .legend {
            margin-bottom: 8px;
        }

            .legend div {
                display: inline-flex;
                align-items: center;
                margin-right: 8px;
            }

        .swatch {
            width: 12px;
            height: 12px;
            margin-right: 4px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Code Graph</h1>
        </header>
        <main>
            <aside>
                <div class="legend"></div>
                <div>
                    <label>Data file: <input type="text" id="dataFile" value="graph.json" /></label>
                    <button id="loadBtn">Load</button>
                </div>
                <div>
                    <label>
                        Filter kind:
                        <select id="kindFilter">
                            <option value="">(all)</option>
                            <option>Project</option>
                            <option>Namespace</option>
                            <option>Class</option>
                            <option>Interface</option>
                            <option>Enum</option>
                            <option>Record</option>
                            <option>Struct</option>
                        </select>
                    </label>
                </div>
            </aside>
            <div id="canvas"></div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <script>
        const colorByKind = {
         Project: '#1f77b4', Namespace: '#9467bd', Class: '#2ca02c', Interface: '#ff7f0e', Enum: '#d62728', Record: '#17becf', Struct: '#8c564b',
         default: '#7f7f7f'
        };

        function legend(container){
         const kinds = Object.keys(colorByKind).filter(k => k !== 'default');
         kinds.forEach(k => {
         const row = document.createElement('div');
         const sw = document.createElement('span'); sw.className = 'swatch'; sw.style.background = colorByKind[k];
         const label = document.createElement('span'); label.textContent = k;
         row.appendChild(sw); row.appendChild(label);
         container.appendChild(row);
         });
        }

        async function loadAndRender(url){
         const res = await fetch(url);
         const data = await res.json();
         renderGraph(data);
        }

        function renderGraph(data){
         const width = document.getElementById('canvas').clientWidth || window.innerWidth -300;
         const height = document.getElementById('canvas').clientHeight || window.innerHeight -60;
         document.getElementById('canvas').innerHTML = '';

         const svg = d3.select('#canvas').append('svg').attr('width', width).attr('height', height);
         const link = svg.append('g').attr('stroke', '#999').attr('stroke-opacity',0.6).selectAll('line');
         const node = svg.append('g').attr('stroke', '#fff').attr('stroke-width',1.5).selectAll('g');

         const simulation = d3.forceSimulation(data.nodes)
         .force('link', d3.forceLink(data.links).id(d => d.id).distance(l => l.kind === 'Contains' ?60 :120).strength(0.2))
         .force('charge', d3.forceManyBody().strength(-200))
         .force('center', d3.forceCenter(width /2, height /2))
         .force('collide', d3.forceCollide(20));

         const links = link.data(data.links).join('line').attr('class', 'link').attr('stroke-width', d => d.kind === 'Usage' ?0.5 :1.0);

         const nodes = node.data(data.nodes).join('g').attr('class', 'node').call(drag(simulation));

         nodes.append('circle').attr('r',6).attr('fill', d => colorByKind[d.kind] || colorByKind.default);
         nodes.append('title').text(d => `${d.name} (${d.kind})`);
         nodes.append('text').text(d => d.name).attr('x',8).attr('y', '0.31em');

         simulation.on('tick', () => {
         links
         .attr('x1', d => d.source.x)
         .attr('y1', d => d.source.y)
         .attr('x2', d => d.target.x)
         .attr('y2', d => d.target.y);

         nodes.attr('transform', d => `translate(${d.x},${d.y})`);
         });

         function drag(simulation) {
         function dragstarted(event, d) {
         if (!event.active) simulation.alphaTarget(0.3).restart();
         d.fx = d.x; d.fy = d.y;
         }

         function dragged(event, d) {
         d.fx = event.x; d.fy = event.y;
         }

         function dragended(event, d) {
         if (!event.active) simulation.alphaTarget(0);
         d.fx = null; d.fy = null;
         }

         return d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
         }
        }

        document.getElementById('loadBtn').addEventListener('click', () => {
         const url = document.getElementById('dataFile').value;
         loadAndRender(url);
        });

        legend(document.querySelector('.legend'));
        loadAndRender('graph.json');
    </script>
</body>
</html>