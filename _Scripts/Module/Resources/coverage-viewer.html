<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__TITLE__</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .project-list {
            list-style: none;
        }
        .project-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s, border-left 0.2s;
            border-left: 3px solid transparent;
        }
        .project-item:hover {
            background: #f8f9fa;
        }
        .project-item.active {
            background: #e3f2fd;
            border-left-color: #667eea;
        }
        .project-name {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        .project-stats {
            font-size: 0.85em;
            color: #666;
        }
        .project-coverage {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 600;
            margin-top: 5px;
        }
        .coverage-excellent { background: #4caf50; color: white; }
        .coverage-high { background: #8bc34a; color: white; }
        .coverage-medium { background: #ff9800; color: white; }
        .coverage-low { background: #f44336; color: white; }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }
        .filter-group select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 0.95em;
        }
        .packages {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .package {
            border-bottom: 1px solid #eee;
        }
        .package:last-child {
            border-bottom: none;
        }
        .package-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .package-header:hover {
            background: #f8f9fa;
        }
        .package-name {
            font-weight: 600;
            color: #333;
        }
        .package-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #666;
        }
        .package-content {
            display: none;
            padding: 0 20px 20px 20px;
        }
        .package.expanded .package-content {
            display: block;
        }
        .expand-icon {
            transition: transform 0.3s;
            color: #667eea;
        }
        .package.expanded .expand-icon {
            transform: rotate(90deg);
        }
        .class-list {
            list-style: none;
        }
        .class-item {
            padding: 12px 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        .class-name {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        .class-file {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        .class-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>__TITLE__</h1>
            <div class="subtitle">Project-based Code Coverage Report</div>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">Projects</div>
            <ul class="project-list" id="projectList">
                <li class="loading">Loading projects...</li>
            </ul>
        </div>

        <div class="content" id="content">
            <div class="loading">Select a project to view coverage details</div>
        </div>
    </div>

    <script>
        let projects = [];
        let currentProject = null;
        let coverageData = null;
        let filteredClasses = [];

        // Load projects manifest
        async function loadProjects() {
            try {
                const response = await fetch('projects.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                projects = await response.json();
                renderProjectList();
                
                // Auto-load first project if available
                if (projects.length > 0) {
                    loadProject(projects[0]);
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectList').innerHTML = 
                    '<li class="error-message">Failed to load projects.json</li>';
            }
        }

        // Render project list in sidebar
        function renderProjectList() {
            const projectList = document.getElementById('projectList');
            
            if (projects.length === 0) {
                projectList.innerHTML = '<li class="no-results">No projects found</li>';
                return;
            }

            projectList.innerHTML = projects.map(project => {
                const coverageClass = getCoverageClass(project.coverage);
                return `
                    <li class="project-item" data-filename="${project.fileName}" onclick="loadProjectByName('${project.fileName}')">
                        <div class="project-name">${project.name}</div>
                        <div class="project-stats">
                            ${project.coveredLines} / ${project.totalLines} lines
                        </div>
                        <div class="project-coverage ${coverageClass}">
                            ${project.coverage}%
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Load a specific project's coverage data
        async function loadProjectByName(fileName) {
            const project = projects.find(p => p.fileName === fileName);
            if (project) {
                await loadProject(project);
            }
        }

        async function loadProject(project) {
            currentProject = project;
            
            // Update active state in sidebar
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.filename === project.fileName) {
                    item.classList.add('active');
                }
            });
            
            // Show loading state
            document.getElementById('content').innerHTML = '<div class="loading">Loading coverage data...</div>';
            
            try {
                const response = await fetch(project.fileName);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                coverageData = await response.json();
                renderCoverageData();
            } catch (error) {
                console.error('Error loading project data:', error);
                document.getElementById('content').innerHTML = 
                    `<div class="error-message">Failed to load coverage data for ${project.name}</div>`;
            }
        }

        // Render coverage data for current project
        function renderCoverageData() {
            if (!coverageData) return;

            const coverage = Math.round((coverageData.lineRate || 0) * 100 * 100) / 100;
            const coverageClass = getCoverageClass(coverage);
            
            // Collect all classes from all packages
            const allClasses = [];
            if (coverageData.packages) {
                coverageData.packages.forEach(pkg => {
                    if (pkg.classes) {
                        pkg.classes.forEach(cls => {
                            allClasses.push({
                                ...cls,
                                packageName: pkg.name || 'Default Package'
                            });
                        });
                    }
                });
            }
            
            filteredClasses = allClasses;

            const html = `
                <div class="summary">
                    <div class="stat-card">
                        <div class="stat-label">Coverage</div>
                        <div class="stat-value ${coverageClass}">${coverage}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Lines</div>
                        <div class="stat-value">${coverageData.totalLines || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Covered Lines</div>
                        <div class="stat-value">${coverageData.coveredLines || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Classes</div>
                        <div class="stat-value">${allClasses.length}</div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <input type="text" id="filterInput" placeholder="Filter by class name or filename..." onkeyup="filterClasses()">
                        <select id="coverageFilter" onchange="filterClasses()">
                            <option value="">All Coverage Levels</option>
                            <option value="excellent">Excellent (≥90%)</option>
                            <option value="high">High (≥75%)</option>
                            <option value="medium">Medium (≥50%)</option>
                            <option value="low">Low (<50%)</option>
                        </select>
                    </div>
                </div>

                <div id="classList" class="packages">
                    ${renderClasses(filteredClasses)}
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        // Render classes
        function renderClasses(classes) {
            if (classes.length === 0) {
                return '<div class="no-results">No classes match the current filters</div>';
            }

            // Group by package
            const packageMap = {};
            classes.forEach(cls => {
                const pkgName = cls.packageName || 'Default Package';
                if (!packageMap[pkgName]) {
                    packageMap[pkgName] = [];
                }
                packageMap[pkgName].push(cls);
            });

            return Object.entries(packageMap).map(([pkgName, pkgClasses]) => {
                const pkgTotalLines = pkgClasses.reduce((sum, cls) => sum + (cls.totalLines || 0), 0);
                const pkgCoveredLines = pkgClasses.reduce((sum, cls) => sum + (cls.coveredLines || 0), 0);
                const pkgCoverage = pkgTotalLines > 0 ? Math.round((pkgCoveredLines / pkgTotalLines) * 100 * 100) / 100 : 0;

                return `
                    <div class="package">
                        <div class="package-header" onclick="togglePackage(this)">
                            <div>
                                <span class="expand-icon">▶</span>
                                <span class="package-name">${pkgName}</span>
                            </div>
                            <div class="package-stats">
                                <span>${pkgClasses.length} classes</span>
                                <span class="${getCoverageClass(pkgCoverage)}">${pkgCoverage}%</span>
                            </div>
                        </div>
                        <div class="package-content">
                            <ul class="class-list">
                                ${pkgClasses.map(cls => renderClass(cls)).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render individual class
        function renderClass(cls) {
            const classCoverage = cls.totalLines > 0 ? Math.round((cls.coveredLines / cls.totalLines) * 100 * 100) / 100 : 0;
            const coverageClass = getCoverageClass(classCoverage);

            return `
                <li class="class-item">
                    <div class="class-name">${cls.name}</div>
                    <div class="class-file">${cls.filename}</div>
                    <div class="class-stats">
                        <div class="stat-item">
                            <span>Coverage:</span>
                            <strong class="${coverageClass}">${classCoverage}%</strong>
                        </div>
                        <div class="stat-item">
                            <span>Lines:</span>
                            <strong>${cls.coveredLines || 0} / ${cls.totalLines || 0}</strong>
                        </div>
                    </div>
                </li>
            `;
        }

        // Filter classes based on search and coverage level
        function filterClasses() {
            if (!coverageData) return;

            const searchTerm = document.getElementById('filterInput').value.toLowerCase();
            const coverageLevel = document.getElementById('coverageFilter').value;

            // Collect all classes
            const allClasses = [];
            if (coverageData.packages) {
                coverageData.packages.forEach(pkg => {
                    if (pkg.classes) {
                        pkg.classes.forEach(cls => {
                            allClasses.push({
                                ...cls,
                                packageName: pkg.name || 'Default Package'
                            });
                        });
                    }
                });
            }

            filteredClasses = allClasses.filter(cls => {
                // Text filter
                const matchesSearch = !searchTerm || 
                    cls.name.toLowerCase().includes(searchTerm) || 
                    cls.filename.toLowerCase().includes(searchTerm);

                // Coverage filter
                const classCoverage = cls.totalLines > 0 ? (cls.coveredLines / cls.totalLines) * 100 : 0;
                const matchesCoverage = !coverageLevel || getCoverageClass(classCoverage) === coverageLevel;

                return matchesSearch && matchesCoverage;
            });

            document.getElementById('classList').innerHTML = renderClasses(filteredClasses);
        }

        // Toggle package expansion
        function togglePackage(element) {
            const package = element.parentElement;
            package.classList.toggle('expanded');
        }

        // Get CSS class based on coverage percentage
        function getCoverageClass(coverage) {
            if (coverage >= 90) return 'coverage-excellent';
            if (coverage >= 75) return 'coverage-high';
            if (coverage >= 50) return 'coverage-medium';
            return 'coverage-low';
        }

        // Initialize
        loadProjects();
    </script>
</body>
</html>
